<!-- <!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pi Stream Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; background: #0b0c10; color: #e5e7eb; }
        header { padding: 12px 16px; background: #111827; }
        main { padding: 16px; display: grid; gap: 12px; }
        video { width: 100%; max-width: 960px; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        .hint { opacity: .8; }
    </style>
</head>
<body>
    <header>
        <h3>Pi A/V Stream</h3>
    </header>
    <main>
        <video id="player" controls autoplay playsinline></video>
        <div class="hint">음소거 해제(🔊)하고 지연/오디오를 확인하세요.</div>
    </main>
    <script>
        const video = document.getElementById('player');
        // MediaMTX HLS 경로
        const hlsUrl = 'http://' + window.location.hostname + ':8888/pi/index.m3u8';;


        if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = hlsUrl; // Safari 등 네이티브 HLS
        } else if (window.Hls && Hls.isSupported()) {
            const hls = new Hls({ lowLatencyMode: true });
            hls.loadSource(hlsUrl);
            hls.attachMedia(video);
        } else {
            document.body.insertAdjacentHTML('beforeend', '<p>이 브라우저는 HLS를 지원하지 않습니다.</p>');
        }
    </script>
</body>
</html> -->

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pi Stream – WebRTC (Low Latency)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0c10; color:#e5e7eb; font-family:system-ui,sans-serif }
    header { padding:12px 16px; background:#111827; display:flex; gap:12px; align-items:center; }
    main { padding:16px; display:grid; gap:14px; }
    video { width:100%; max-width:960px; aspect-ratio:16/9; background:#000; border-radius:12px }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    button { padding:8px 12px; border:0; border-radius:10px; background:#2563eb; color:#fff; cursor:pointer }
    button.secondary { background:#374151 }
    input[type=text] { padding:8px 10px; border-radius:10px; border:1px solid #374151; background:#111827; color:#e5e7eb }
    small { opacity:.8 }
    a { color:#93c5fd }
  </style>
</head>
<body>
  <header>
    <strong>Pi Stream</strong>
    <small>WebRTC ⏱️ ultra-low latency</small>
  </header>

  <main>
    <video id="vid" playsinline autoplay muted></video>

    <div class="row">
      <label>Path:</label>
      <input id="path" type="text" value="pi" size="10" />
      <button id="btnConnect">Connect (WebRTC)</button>
      <button id="btnDisconnect" class="secondary">Disconnect</button>
      <button id="btnMute" class="secondary">Unmute 🔊</button>
    </div>

    <div class="row">
      <small>
        Fallback(HLS): <a id="hlsLink" href="#" target="_blank">open m3u8</a> ·
        MediaMTX page: <a id="webrtcPage" href="#" target="_blank">open 8889 UI</a>
      </small>
    </div>

    <small id="status">Idle</small>
  </main>

<script>
(() => {
  const video = document.getElementById('vid');
  const btnConnect = document.getElementById('btnConnect');
  const btnDisconnect = document.getElementById('btnDisconnect');
  const btnMute = document.getElementById('btnMute');
  const statusEl = document.getElementById('status');
  const pathEl = document.getElementById('path');

  const host = window.location.hostname;
  const whepURL = (p) => `http://${host}:8889/${encodeURIComponent(p)}/whep`;
  const hlsURL  = (p) => `http://${host}:8888/${encodeURIComponent(p)}/index.m3u8`;
  const webrtcUI = (p) => `http://${host}:8889/?path=${encodeURIComponent(p)}`;

  // links
  const applyLinks = () => {
    const p = pathEl.value.trim() || 'pi';
    document.getElementById('hlsLink').href = hlsURL(p);
    document.getElementById('webrtcPage').href = webrtcUI(p);
  };
  applyLinks();
  pathEl.addEventListener('input', applyLinks);

  let pc = null;
  let resourceURL = null; // WHEP session URL (Location header)

  function setStatus(t) { statusEl.textContent = t; console.log(t); }

  async function connect() {
    const path = pathEl.value.trim() || 'pi';
    if (pc) await disconnect();

    pc = new RTCPeerConnection();
    pc.addTransceiver('video', {direction:'recvonly'});
    pc.addTransceiver('audio', {direction:'recvonly'});
    pc.ontrack = (ev) => {
      const [stream] = ev.streams;
      if (stream && video.srcObject !== stream) video.srcObject = stream;
    };
    pc.onconnectionstatechange = () => setStatus(`State: ${pc.connectionState}`);

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // WHEP: POST offer SDP -> receive answer SDP
    const resp = await fetch(whepURL(path), {
      method: 'POST',
      headers: {'Content-Type': 'application/sdp', 'Accept':'application/sdp'},
      body: offer.sdp
    });

    if (!resp.ok) {
      setStatus(`WHEP POST failed: ${resp.status}`);
      await disconnect();
      return;
    }

    const answerSDP = await resp.text();
    resourceURL = resp.headers.get('Location'); // optional, for DELETE on teardown
    await pc.setRemoteDescription({type:'answer', sdp: answerSDP});
    setStatus('Connected (WebRTC). Tip: click Unmute 🔊');
  }

  async function disconnect() {
    try {
      if (resourceURL) {
        // Optional WHEP teardown (some servers support DELETE)
        fetch(resourceURL, { method: 'DELETE' }).catch(()=>{});
      }
      if (pc) pc.close();
    } finally {
      pc = null;
      resourceURL = null;
      video.srcObject = null;
      setStatus('Disconnected');
    }
  }

  btnConnect.onclick = connect;
  btnDisconnect.onclick = disconnect;

  btnMute.onclick = () => {
    video.muted = !video.muted;
    btnMute.textContent = video.muted ? 'Unmute 🔊' : 'Mute 🔇';
  };

  window.addEventListener('beforeunload', disconnect);
})();
</script>
</body>
</html>
